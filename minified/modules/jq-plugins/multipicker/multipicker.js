define(["jquery"],function(a){var b=function(a){return"number"==typeof a||/^\d+(\.\d+)?$/.test(a)},c=function(b,d){this.$element=a(b),d=d&&"object"==typeof d?d:{},this.options=a.extend({},c.DEFAULTS,d),this.options.toColumn=a.extend({},c.DEFAULTS.toColumn,d.toColumn),this.options.fromColumn=a.extend({},c.DEFAULTS.fromColumn,d.fromColumn),this.create(),this.bindEvents(),this.handleEvents(),this.$wrapper.trigger(a.Event("created.multipicker"))};c.VERSION="0.8.2",c.DATA_KEY="item.multipicker",c.INST_KEY="ui.multipicker",c.TYPE_SELECTED="selected",c.TYPE_UNSELECTED="unselected",c.DEFAULTS={height:"auto",minHeight:300,maxHeight:400,toColumn:{title:"已选栏",cssClass:"col-sm-6",items:[],empty:"未添加选项",loadText:"加载更多",loadingText:"正在加载...",loadErrorText:"加载失败！点击重新加载",loadEmpty:"没有更多项了",loadMore:null},fromColumn:{title:"可选栏",cssClass:"col-sm-6",items:[],empty:"没有可选项",loadText:"加载更多",loadingText:"正在加载...",loadErrorText:"加载失败！点击重新加载",loadEmpty:"没有更多项了",loadMore:null},dataSrc:null,oncreated:null,onchanged:null,onselected:null,ondeselected:null},c.DEFAULTS.ITEM={name:"",icon:!0},c.ITEM=function(b){var d=this;"string"==typeof b?(this.originalData=b,a.each(c.DEFAULTS.ITEM,function(a,c){d[a]="name"==a?b:c})):(this.originalData=b?a.extend({},b):b,b=a.extend({},c.DEFAULTS.ITEM,b),a.each(b,function(a,b){d[a]=b}))},c.prototype.bindEvents=function(){return this.$wrapper.off("created.multipicker").on("created.multipicker",a.proxy(function(a){"function"==typeof this.options.oncreated&&this.options.oncreated.apply(this,arguments)},this)),this.$wrapper.off("changed.multipicker").on("changed.multipicker",a.proxy(function(b){"function"==typeof this.options.onchanged&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.onchanged.apply(this,arguments))},this)),this.$wrapper.off("selected.multipicker").on("selected.multipicker",a.proxy(function(b){"function"==typeof this.options.onselected&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.onselected.apply(this,arguments))},this)),this.$wrapper.off("deselected.multipicker").on("deselected.multipicker",a.proxy(function(b){"function"==typeof this.options.ondeselected&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.ondeselected.apply(this,arguments))},this)),this},c.prototype.create=function(){var b=this.options,d=a('<div class="multipicker-column-to"><fieldset><legend class="multipicker-column-title">'+b.toColumn.title+'</legend><div class="multipicker-column-filter"><i class="multipicker-icon-search"></i><input class="form-control" type="search" /></div><ul class="multipicker-column-list"></ul></fieldset></div>'),e=a('<div class="multipicker-column-from"><fieldset><legend class="multipicker-column-title">'+b.fromColumn.title+'</legend><div class="multipicker-column-filter"><i class="multipicker-icon-search"></i><input class="form-control" type="search" /></div><ul class="multipicker-column-list"></ul></fieldset></div>');d.addClass(b.toColumn.cssClass);var f=a(".multipicker-column-list",d),g=this.createItems(b.toColumn.items,c.TYPE_SELECTED);f.append(g),e.addClass(b.fromColumn.cssClass);var h=a(".multipicker-column-list",e),i=this.createItems(b.fromColumn.items,c.TYPE_UNSELECTED);return h.append(i),this.$element.hasClass("row")||this.$element.hasClass("multipicker-wrapper")?(this.$wrapper=this.$element,this.$element.hasClass("multipicker-wrapper")||this.$wrapper.addClass("multipicker-wrapper")):(this.$element.append('<div class="multipicker-wrapper"></div>'),this.$wrapper=a(".multipicker-wrapper:last",this.$element)),this.$wrapper.empty().append(e).append(d),this.$toColumn=a(".multipicker-column-to",this.$wrapper),this.$toList=a(".multipicker-column-list",this.$toColumn),!this.$wrapper.hasClass("row")&&this.$toColumn[0]&&this.$toColumn[0].className&&this.$toColumn[0].className.indexOf("col-")>-1&&this.$wrapper.addClass("row"),this.createMoreItem(c.TYPE_SELECTED),this.$fromColumn=a(".multipicker-column-from",this.$wrapper),this.$fromList=a(".multipicker-column-list",this.$fromColumn),!this.$wrapper.hasClass("row")&&this.$fromColumn[0]&&this.$fromColumn[0].className&&this.$fromColumn[0].className.indexOf("col-")>-1&&this.$wrapper.addClass("row"),this.createMoreItem(c.TYPE_UNSELECTED),this.orgSelectedItems=this.getSelectedItems(),b.height&&"auto"!==b.height?this.setHeight():(this.setMinHeight(),this.setMaxHeight()),this.checkEmpty(),this},c.prototype.createItem=function(b,d){if(b&&b.name){var e,f,g;return d===c.TYPE_SELECTED?(f="delete",g="移除",e="双击移除"):(f="add",g="选择",e="双击选择"),a('<li class="multipicker-column-item">'+(b.icon?'<i class="multipicker-icon-'+f+'" title="'+g+'"></i>':"")+'<a title="'+e+'">'+b.name+"</a></li>").data(c.DATA_KEY,b)}return a([])},c.prototype.createItems=function(b,d){b=b||[];var e=this,f=a([]);return a.each(b,function(a,b){f=f.add(e.createItem(new c.ITEM(b),d))}),f},c.prototype.createMoreItem=function(a){return a===c.TYPE_SELECTED&&this.options.toColumn.loadMore?this.$toList.children(".multipicker-column-more").length<=0&&this.$toList.append('<li class="multipicker-column-more"><a href="javascript:;">'+this.options.toColumn.loadText+"</a></li>"):a===c.TYPE_UNSELECTED&&this.options.fromColumn.loadMore&&this.$fromList.children(".multipicker-column-more").length<=0&&this.$fromList.append('<li class="multipicker-column-more"><a href="javascript:;">'+this.options.fromColumn.loadText+"</a></li>"),this},c.prototype.checkEmpty=function(){var b=this.$toList.children(".multipicker-column-item"),c=this.$toList.children(".multipicker-column-empty");b.length?c.length&&c.remove():(c.length?c.html(this.options.toColumn.empty):this.$toList.prepend('<li class="multipicker-column-empty">'+this.options.toColumn.empty+"</li>"),a(".multipicker-column-more",this.$toList).remove());var d=this.$fromList.children(".multipicker-column-item"),e=this.$fromList.children(".multipicker-column-empty");d.length?e.length&&e.remove():(e.length?e.html(this.options.fromColumn.empty):this.$fromList.prepend('<li class="multipicker-column-empty">'+this.options.fromColumn.empty+"</li>"),a(".multipicker-column-more",this.$fromList).remove())},c.prototype.handleEvents=function(){var b=this;this.$toColumn.find('input[type="search"]').on("keypress.multipicker",function(a){13==a.keyCode&&b.searchTo()}),this.$toColumn.find(".multipicker-icon-search").on("click.multipicker",function(){b.searchTo()}),this.$fromColumn.find('input[type="search"]').on("keypress.multipicker",function(a){13==a.keyCode&&b.searchFrom()}),this.$fromColumn.find(".multipicker-icon-search").on("click.multipicker",function(){b.searchFrom()});var d=function(d){var e=b.createItem(d.data(c.DATA_KEY),c.TYPE_SELECTED);b.$toList.prepend(e),d.remove(),b.checkEmpty(),b.$wrapper.trigger(a.Event("selected.multipicker",{relatedTarget:e[0]})),b.isChanged()&&b.$wrapper.trigger(a.Event("changed.multipicker",{relatedTarget:e[0]}))},e=function(d){var e=b.createItem(d.data(c.DATA_KEY),c.TYPE_UNSELECTED);b.$fromList.prepend(e),d.remove(),b.checkEmpty(),b.$wrapper.trigger(a.Event("deselected.multipicker",{relatedTarget:e[0]})),b.isChanged()&&b.$wrapper.trigger(a.Event("changed.multipicker",{relatedTarget:e[0]}))};return this.$toList.on("dblclick.multipicker",".multipicker-column-item>a",function(){e(a(this).parents("li:first"))}),this.$toList.on("click.multipicker",".multipicker-icon-delete",function(){e(a(this).parents("li:first"))}),this.$fromList.on("dblclick.multipicker",".multipicker-column-item>a",function(){d(a(this).parents("li:first"))}),this.$fromList.on("click.multipicker",".multipicker-icon-add",function(){d(a(this).parents("li:first"))}),this.$toList.on("click.multipicker",".multipicker-column-more>a",this,function(b){if(a(this).hasClass("done")||a(this).hasClass("loading"))return!1;b.data.loadMoreTo()}),this.$fromList.on("click.multipicker",".multipicker-column-more>a",this,function(b){if(a(this).hasClass("done")||a(this).hasClass("loading"))return!1;b.data.loadMoreFrom()}),this},c.prototype.setHeight=function(a){return void 0===a&&(a=this.options.height),this.$toList.css("height",a+(b(a)?"px":"")),this.$fromList.css("height",a+(b(a)?"px":"")),this},c.prototype.setMinHeight=function(a){return void 0===a&&(a=this.options.minHeight),this.$toList.css("minHeight",a+(b(a)?"px":"")),this.$fromList.css("minHeight",a+(b(a)?"px":"")),this},c.prototype.setMaxHeight=function(a){return void 0===a&&(a=this.options.maxHeight),this.$toList.css("maxHeight",a+(b(a)?"px":"")),this.$fromList.css("maxHeight",a+(b(a)?"px":"")),this},c.prototype.isChanged=function(){if(this.orgSelectedItems){var a=this.getSelectedItems();if(this.orgSelectedItems.length!=a.length)return!0;for(var b in a)if(this.orgSelectedItems.indexOf(a[b])<0)return!0}return!1},c.prototype.searchTo=function(b){return void 0===b&&(b=this.$toColumn.find('input[type="search"]').val()),this.$toList.children(".multipicker-column-item").each(function(){var d=a(this),e=d.data(c.DATA_KEY);b&&e.name.indexOf(b)<0?d.hide():d.show(),e=null,d=null}),this},c.prototype.searchFrom=function(b){return void 0===b&&(b=this.$fromColumn.find('input[type="search"]').val()),this.$fromList.children(".multipicker-column-item").each(function(){var d=a(this),e=d.data(c.DATA_KEY);b&&e.name.indexOf(b)<0?d.hide():d.show(),e=null,d=null}),this},c.prototype.loadMoreTo=function(){var b=this;if("function"==typeof this.options.toColumn.loadMore){var c=this.loadedNumTo,d=this.options.toColumn.loadMore.call(this,c);d&&"function"==typeof d.done?(this.loadingMoreTo(),d.done(function(c){a.isArray(c)&&c.length?(b.loadedMoreTo(c.length),b.addSelectedItems(c)):b.doneMoreTo()}).fail(function(){b.errorMoreTo.apply(b,arguments)})):b.doneMoreTo()}return this},c.prototype.loadMoreFrom=function(){var b=this;if("function"==typeof this.options.fromColumn.loadMore){var c=this.loadedNumFrom,d=this.options.fromColumn.loadMore.call(this,c);d&&"function"==typeof d.done?(this.loadingMoreFrom(),d.done(function(c){a.isArray(c)&&c.length?(b.loadedMoreFrom(c),b.addUnSelectedItems(c)):b.doneMoreFrom()}).fail(function(){b.errorMoreFrom.apply(b,arguments)})):b.doneMoreFrom()}return this},c.prototype.loadingMoreTo=function(){return this.$toList.find(".multipicker-column-more").removeClass("error").addClass("loading").children("a").text(this.options.toColumn.loadingText),this},c.prototype.loadingMoreFrom=function(){return this.$fromList.find(".multipicker-column-more").removeClass("error").addClass("loading").children("a").text(this.options.fromColumn.loadingText),this},c.prototype.loadedMoreTo=function(a){return this.loadedNumTo=this.loadedNumTo||0,"number"==typeof a&&a>=0&&(this.loadedNumTo+=a),this.$toList.find(".multipicker-column-more").removeClass("loading").children("a").text(this.options.toColumn.loadText),this},c.prototype.loadedMoreFrom=function(a){return this.loadedNumFrom=this.loadedNumFrom||0,"number"==typeof a&&a>=0&&(this.loadedNumFrom+=a),this.$fromList.find(".multipicker-column-more").removeClass("loading").children("a").text(this.options.fromColumn.loadText),this},c.prototype.errorMoreTo=function(){return this.$toList.find(".multipicker-column-more").removeClass("loading").addClass("error").children("a").text(this.options.toColumn.loadErrorText),this},c.prototype.errorMoreFrom=function(){return this.$fromList.find(".multipicker-column-more").removeClass("loading").addClass("error").children("a").text(this.options.fromColumn.loadErrorText),this},c.prototype.doneMoreTo=function(){return this.$toList.find(".multipicker-column-more").removeClass("loading loaded error").addClass("done").children("a").text(this.options.toColumn.loadEmpty),this},c.prototype.doneMoreFrom=function(){return this.$fromList.find(".multipicker-column-more").removeClass("loading loaded error").addClass("done").children("a").text(this.options.fromColumn.loadEmpty),this},c.prototype.addSelectedItems=function(a){var b=this.createItems(a,c.TYPE_SELECTED);return this.$toList.children(".multipicker-column-item:last").after(b),this},c.prototype.addUnSelectedItems=function(a){var b=this.createItems(a,c.TYPE_UNSELECTED);return this.$fromList.children(".multipicker-column-item:last").after(b),this},c.prototype.setSelectedItems=function(a){var b=this.createItems(a,c.TYPE_SELECTED);return this.$toList.empty().append(b),this.createMoreItem(c.TYPE_SELECTED),this},c.prototype.setUnSelectedItems=function(a){var b=this.createItems(a,c.TYPE_UNSELECTED);return this.$fromList.empty().append(b),this.createMoreItem(c.TYPE_UNSELECTED),this},c.prototype.getSelectedItems=function(){var b,d=[];return this.$toList.children(".multipicker-column-item").each(function(){(b=a(this).data(c.DATA_KEY))&&d.push(b)}),d},c.prototype.getSelectedData=function(){var b=this,c=[],d=this.getSelectedItems();return a.each(d,function(a,d){c.push(b._getDataSource(d.originalData))}),c},c.prototype.getSelectedElements=function(){var a=[];return this.$toList.children(".multipicker-column-item").each(function(){a.push(this)}),a},c.prototype.getUnSelectedItems=function(){var b,d=[];return this.$fromList.children(".multipicker-column-item").each(function(){(b=a(this).data(c.DATA_KEY))&&d.push(b)}),d},c.prototype.getUnSelectedData=function(){var b=this,c=[],d=this.getUnSelectedItems();return a.each(d,function(a,d){c.push(b._getDataSource(d.originalData))}),c},c.prototype.getUnSelectedElements=function(){var a=[];return this.$fromList.children(".multipicker-column-item").each(function(){a.push(this)}),a},c.prototype._getDataSource=function(b){if(!b||!this.options.dataSrc||"object"!=typeof b)return b;var c;return"object"==typeof this.options.dataSrc?a.each(this.options.dataSrc,function(a,d){!c&&(c={}),c[d]=b[d]}):c=b[this.options.dataSrc],c};var d=a.fn.multiPicker;return a.fn.multiPicker=function(b){var d,e=a(this);if((d=e.data(c.INST_KEY))||e.data(c.INST_KEY,d=new c(this,b)),"string"==typeof b&&d){var f=d[b];if("function"==typeof f){var g=Array.prototype.slice.call(arguments,1);return f.apply(d,g)}throw"MultiPicker Error: Method "+f+" does not exist"}return this},a.fn.multiPicker.Constructor=c,a.fn.multiPicker.noConflict=function(){return a.fn.multiPicker=d,this},c});